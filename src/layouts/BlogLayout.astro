---
import aboutImage from '@/assets/about-image.webp';
import ArticleCard from '@/components/ArticleCard.astro';
import SocialLink from '@/components/SocialLink.astro';
import SocialShare from '@/components/SocialShare.astro';
import SponsorsSidebar from '@/components/SponsorsSidebar.astro';
import { authorBio } from '@/config';
import { Image } from 'astro:assets';
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from './Layout.astro';

const socials = await getCollection('socials');

interface Props {
  title: string;
  description: string;
  author: string;
  dateCreated: Date;
  tags?: string[];
  coverImage?: string;
  series?: string;
  readingTime: number;
  sponsors?: CollectionEntry<'sponsors'>[];
  relatedBlogs?: CollectionEntry<'blog'>[];
}

const {
  title,
  description,
  author,
  dateCreated,
  tags = [],
  coverImage,
  series,
  readingTime,
  sponsors = [],
  relatedBlogs = [],
} = Astro.props;

const hasSponsors = sponsors.length > 0;

// Format date
const formattedDate = dateCreated.toLocaleDateString('en-US', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

const seriesSlug = series ? series.toLowerCase().replace(/\s+/g, '-') : null;

const pageTitle = `${title} | Lewis Kori`;
const publishedTime = dateCreated.toISOString();
---

<Layout
  title={pageTitle}
  description={description}
  image={coverImage}
  author={author}
  publishedTime={publishedTime}
  type='article'
>
  <article class='py-20 px-4 min-h-screen'>
    <div class='container-fluid'>
      <div class='mb-8'>
        <a
          href='/blog'
          class='inline-flex items-center gap-2 text-secondary hover:underline'
        >
          <svg
            xmlns='http://www.w3.org/2000/svg'
            width='20'
            height='20'
            viewBox='0 0 24 24'
            fill='none'
            stroke='currentColor'
            stroke-width='2'
            stroke-linecap='round'
            stroke-linejoin='round'
          >
            <path d='m15 18-6-6 6-6'></path>
          </svg>
          Back to all posts
        </a>
      </div>

      <header class='mb-12'>
        <div class='grid lg:grid-cols-5 gap-8'>
          <div class='lg:col-span-3 space-y-4'>
            <h1
              class='text-3xl md:text-4xl font-semibold dark:first-letter:text-secondary first-letter:text-destructive retro:first-letter:text-primary'
            >
              {title}
            </h1>
            <div
              class='flex flex-wrap items-center gap-4 text-muted-foreground text-sm'
            >
              <time datetime={dateCreated.toISOString()}>
                Posted {formattedDate}
              </time>
              <span>•</span>
              <span>By {author}</span>
              <span>•</span>
              <span>{readingTime} min read</span>
            </div>
            {
              series && (
                <div class='mt-2'>
                  <a
                    href={`/blog?series=${seriesSlug}`}
                    class='inline-flex items-center gap-2 text-sm font-medium text-secondary hover:underline'
                  >
                    <svg
                      xmlns='http://www.w3.org/2000/svg'
                      width='16'
                      height='16'
                      viewBox='0 0 24 24'
                      fill='none'
                      stroke='currentColor'
                      stroke-width='2'
                      stroke-linecap='round'
                      stroke-linejoin='round'
                    >
                      <path d='M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20' />
                    </svg>
                    Part of series: {series}
                  </a>
                </div>
              )
            }
            {
              tags && tags.length > 0 && (
                <div class='flex flex-wrap gap-2'>
                  {tags.map((tag) => (
                    <span class='px-3 py-1 text-xs rounded-full bg-primary/10 text-primary'>
                      #{tag}
                    </span>
                  ))}
                </div>
              )
            }
            {
              coverImage && (
                <Image
                  src={coverImage}
                  width={1000}
                  height={500}
                  alt={title}
                  class='w-full rounded-lg shadow-lg mt-6'
                />
              )
            }
            <div class='mt-6'>
              <SocialShare
                url={Astro.url.href}
                title={title}
                description={description}
              />
            </div>
          </div>

          <aside class='lg:col-span-2'>
            <div class='sticky top-24 space-y-6'>
              <div class='space-y-4'>
                <div class='flex items-center gap-4'>
                  <Image
                    src={aboutImage}
                    alt={authorBio.name}
                    width={80}
                    height={80}
                    class='rounded-full size-16 border-2 border-primary'
                  />
                  <div>
                    <h3 class='font-semibold text-lg'>{authorBio.name}</h3>
                    <p class='text-sm text-muted-foreground'>
                      {authorBio.tagline}
                    </p>
                  </div>
                </div>
                <p class='text-sm text-muted-foreground leading-relaxed'>
                  {authorBio.description}
                </p>

                <div class='flex gap-3 pt-2'>
                  {socials.map((social) => <SocialLink {...social.data} />)}
                </div>
              </div>
            </div>
          </aside>
        </div>
      </header>

      <!-- Main Content Grid -->
      <div
        class:list={[
          'grid gap-8',
          hasSponsors ? 'lg:grid-cols-5' : 'grid-cols-1  mx-auto',
        ]}
      >
        <!-- Blog Content -->
        <div
          class:list={[
            'max-w-none leading-7 [&_h1]:text-4xl [&_h1]:font-bold [&_h1]:mt-8 [&_h1]:mb-4 [&_h2]:text-3xl [&_p]:text-primary retro:[&_p]:text-secondary [&_h2]:font-bold [&_h2]:mt-8 [&_h2]:mb-4 [&_h3]:text-2xl [&_h3]:font-bold [&_h3]:mt-8 [&_h3]:mb-4 [&_h4]:text-xl [&_h4]:font-bold [&_h4]:mt-8 [&_h4]:mb-4 [&_h5]:text-lg [&_h5]:font-bold [&_h5]:mt-8 [&_h5]:mb-4 [&_h6]:text-base [&_h6]:font-bold [&_h6]:mt-8 [&_h6]:mb-4 [&_p]:mb-4 [&_a]:underline dark:[&_a]:text-secondary retro:[&_a]:text-primary [&_a]:text-destructive [&_ul]:mb-4 [&_ul]:ml-6 [&_ul]:list-disc [&_ul]:list-outside [&_ol]:mb-4 [&_ol]:ml-6 [&_ol]:list-decimal [&_ol]:list-outside [&_li]:mb-2 [&_code]:px-1.5 [&_code]:py-0.5 [&_code]:rounded [&_code]:text-sm [&_code]:font-mono [&_code]:bg-base-200 [&_pre]:p-4 [&_pre]:rounded-lg [&_pre]:overflow-x-auto [&_pre]:mb-4 [&_pre]:bg-base-200 [&_pre_code]:bg-transparent [&_pre_code]:p-0 [&_blockquote]:border-l-4 [&_blockquote]:border-secondary [&_blockquote]:pl-4 [&_blockquote]:italic [&_blockquote]:my-4 [&_img]:rounded-lg [&_img]:my-6',
            hasSponsors ? 'lg:col-span-3' : '',
          ]}
        >
          <slot />
        </div>

        <!-- Sponsors Sidebar -->
        {hasSponsors && <SponsorsSidebar sponsors={sponsors} />}
      </div>

      <div class='mt-12 pt-12 border-t border-border'>
        <SocialShare
          url={Astro.url.href}
          title={title}
          description={description}
        />
      </div>

      <!-- Related Blogs Section -->
      {
        relatedBlogs.length > 0 && (
          <section class='mt-16 pt-16 border-t border-border'>
            <div class='mb-8'>
              <h2 class='text-2xl md:text-3xl font-semibold mb-2'>
                More from this series
              </h2>
              <p class='text-muted-foreground'>
                Continue reading the {series} series
              </p>
            </div>
            <div class='grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'>
              {relatedBlogs.map((blog) => {
                const blogSlug = blog.id.replace(/\.md$/, '');
                return (
                  <ArticleCard
                    title={blog.data.title}
                    description={blog.data.description}
                    dateCreated={blog.data.dateCreated}
                    tags={blog.data.tags}
                    slug={blogSlug}
                    cover_image={blog.data.cover_image}
                  />
                );
              })}
            </div>
          </section>
        )
      }
    </div>
  </article>
</Layout>
