---
import { getCollection } from 'astro:content';

const experiences = await getCollection('experience');
const sortedExperiences = experiences.sort(
  (a, b) => a.data.order - b.data.order,
);
---

<section class='py-20 relative' id='work'>
  <div class='container-fluid'>
    <div>
      <h2
        class='text-4xl font-semibold first-letter-color text-foreground mb-3 text-center'
      >
        Where I've Worked
      </h2>
      <div
        class='h-1 w-20 bg-linear-to-r from-primary to-secondary rounded-full mx-auto mb-16'
      >
      </div>
    </div>

    <div class='grid md:grid-cols-[250px_1fr] gap-8'>
      <div
        class='flex md:flex-col overflow-x-auto md:overflow-x-visible space-x-1 md:space-x-0 md:space-y-2 pb-4 md:pb-0'
      >
        {
          sortedExperiences.map((exp, index) => (
            <button
              data-tab={exp.data.id}
              class={`shrink-0 md:w-full text-left text-sm md:text-base  hover:border-secondary/30 retro:hover:border-primary/30 px-4 md:px-6 py-1.5 md:py-4 rounded-md md:border-l-4 border-b-4 md:border-b-0 transition-all duration-300 hover:bg-primary/5 ${
                index === 0
                  ? 'bg-primary/10 border-secondary retro:border-primary text-primary font-medium'
                  : 'border-transparent text-muted-foreground '
              }`}
            >
              {exp.data.company}
            </button>
          ))
        }
      </div>

      <div class='relative min-h-100'>
        {
          sortedExperiences.map((exp, index) => (
            <div
              data-content={exp.data.id}
              class={`transition-all duration-500 ${
                index === 0
                  ? 'opacity-100 translate-x-0 relative'
                  : 'opacity-0 translate-x-4 pointer-events-none absolute inset-0'
              }`}
            >
              <div class='space-y-6'>
                <div>
                  <h3 class='text-3xl font-bold text-foreground mb-2'>
                    {exp.data.role}
                    <a
                      href={exp.data.website}
                      target='_blank'
                      rel='noopener noreferrer'
                      class='text-secondary hover:underline inline-flex items-center gap-1'
                    >
                      @ {exp.data.company}
                      <svg
                        class='w-5 h-5'
                        fill='none'
                        viewBox='0 0 24 24'
                        stroke='currentColor'
                      >
                        <path
                          stroke-linecap='round'
                          stroke-linejoin='round'
                          stroke-width='2'
                          d='M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14'
                        />
                      </svg>
                    </a>
                  </h3>
                  <p class='text-muted-foreground font-medium'>
                    {exp.data.period}
                  </p>
                </div>

                <ul class='space-y-4'>
                  {exp.data.responsibilities.map((responsibility) => (
                    <li class='flex gap-3 text-muted-foreground leading-relaxed items-baseline'>
                      <svg
                        class='w-4 h-4  text-secondary shrink-0 mt-1.5'
                        fill='none'
                        viewBox='0 0 24 24'
                        stroke='currentColor'
                      >
                        <path
                          stroke-linecap='round'
                          stroke-linejoin='round'
                          stroke-width='2'
                          d='M9 5l7 7-7 7'
                        />
                      </svg>
                      <span>{responsibility}</span>
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          ))
        }
      </div>
    </div>
  </div>
</section>

<script>
  function initExperienceTabs() {
    const tabs = document.querySelectorAll('[data-tab]');
    const contents = document.querySelectorAll('[data-content]');

    tabs.forEach((tab) => {
      tab.addEventListener('click', () => {
        const targetId = tab.getAttribute('data-tab');

        // Update tab styles
        tabs.forEach((t) => {
          if (t.getAttribute('data-tab') === targetId) {
            t.classList.add(
              'bg-primary/10',
              'border-secondary',
              'retro:border-primary',
              'text-primary',
              'font-medium',
            );
            t.classList.remove('border-transparent', 'text-muted-foreground');
          } else {
            t.classList.remove(
              'bg-primary/10',
              'border-secondary',
              'retro:border-primary',
              'text-primary',
              'font-medium',
            );
            t.classList.add('border-transparent', 'text-muted-foreground');
          }
        });

        // Update content visibility with transitions
        contents.forEach((content) => {
          if (content.getAttribute('data-content') === targetId) {
            content.classList.remove(
              'opacity-0',
              'translate-x-4',
              'pointer-events-none',
              'absolute',
              'inset-0',
            );
            content.classList.add('opacity-100', 'translate-x-0', 'relative');
          } else {
            content.classList.add(
              'opacity-0',
              'translate-x-4',
              'pointer-events-none',
              'absolute',
              'inset-0',
            );
            content.classList.remove(
              'opacity-100',
              'translate-x-0',
              'relative',
            );
          }
        });
      });
    });
  }

  initExperienceTabs();

  document.addEventListener('astro:page-load', initExperienceTabs);
</script>
