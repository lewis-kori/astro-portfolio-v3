---
import NewsletterForm from './NewsletterForm.astro';

interface Props {
  triggerDelay?: number; // in milliseconds, default 7 seconds
}

const { triggerDelay = 7000 } = Astro.props;
---

<!-- Newsletter Modal Backdrop -->
<div
  id='newsletter-modal-backdrop'
  class='hidden fixed inset-0 bg-black/60 backdrop-blur-sm z-50 opacity-0 transition-opacity duration-200 items-center justify-center'
  aria-hidden='true'
>
  <div
    id='newsletter-modal'
    class='w-full max-w-lg mx-4 bg-card border border-border rounded-lg shadow-2xl opacity-0 scale-95 transition-all duration-300'
    role='dialog'
    aria-modal='true'
    aria-labelledby='modal-title'
  >
    <div class='px-4 py-8 md:px-8'>
      <div class='text-center mb-6'>
        <h2
          id='modal-title'
          class='text-2xl font-semibold first-letter-color text-foreground mb-2'
        >
          Enjoying the read?
        </h2>
        <p class='text-sm md:text-base text-muted-foreground'>
          Join my newsletter for more insights on software engineering,
          startups, and tech trends.
        </p>
      </div>

      <NewsletterForm
        id='newsletter-modal-form'
        showTitle={false}
        layout='horizontal'
      />
      <div class='w-full justify-center flex'>
        <button
          id='close-newsletter-modal'
          aria-label='Close newsletter popup'
          class='text-sm font-semibold text-muted-foreground justify-center flex cursor-pointer items-center group text-center mt-4'
        >
          No thanks <svg
            xmlns='http://www.w3.org/2000/svg'
            class='inline-block w-4 h-4 ml-1 transition-transform duration-300 group-hover:translate-x-1'
            fill='none'
            viewBox='0 0 24 24'
            stroke='currentColor'
            stroke-width='2'
          >
            <path
              stroke-linecap='round'
              stroke-linejoin='round'
              d='M9 5l7 7-7 7'></path>
          </svg>
        </button>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ triggerDelay }}>
  function initNewsletterModal() {
    const STORAGE_KEY = 'newsletter_subscribed';
    const DISMISSED_KEY = 'newsletter_modal_dismissed';
    const backdrop = document.getElementById('newsletter-modal-backdrop');
    const closeButton = document.getElementById('close-newsletter-modal');
    const modalForm = document.querySelector(
      '[data-form-id="newsletter-modal-form"]',
    );

    if (!backdrop || !closeButton) return;

    // Check if user has already subscribed or dismissed
    const hasSubscribed = localStorage.getItem(STORAGE_KEY) === 'true';
    const hasDismissed = localStorage.getItem(DISMISSED_KEY) === 'true';

    if (hasSubscribed || hasDismissed) {
      return; // Don't show modal
    }

    let modalShown = false;

    // Show modal after delay
    const showModalTimer = setTimeout(() => {
      if (!modalShown) {
        const modal = document.getElementById('newsletter-modal');
        backdrop.classList.remove('hidden');
        backdrop.classList.add('flex');
        backdrop.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            backdrop.classList.remove('opacity-0');
            backdrop.classList.add('opacity-100');
            if (modal) {
              modal.classList.remove('opacity-0', 'scale-95');
              modal.classList.add('opacity-100', 'scale-100');
            }
          });
        });

        modalShown = true;
      }
    }, triggerDelay);

    // Close modal function
    function closeModal() {
      const modal = document.getElementById('newsletter-modal');
      backdrop.classList.remove('opacity-100');
      backdrop.classList.add('opacity-0');
      if (modal) {
        modal.classList.remove('opacity-100', 'scale-100');
        modal.classList.add('opacity-0', 'scale-95');
      }

      // Add hidden class after transition completes
      setTimeout(() => {
        backdrop.classList.add('hidden');
        backdrop.classList.remove('flex');
        backdrop.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
      }, 300);

      localStorage.setItem(DISMISSED_KEY, 'true');
      clearTimeout(showModalTimer);
    }

    closeButton.addEventListener('click', closeModal);

    backdrop.addEventListener('click', (e) => {
      if (e.target === backdrop) {
        closeModal();
      }
    });

    // Close on Escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !backdrop.classList.contains('hidden')) {
        closeModal();
      }
    });

    // Listen for successful subscription
    if (modalForm) {
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (mutation.type === 'childList' || mutation.type === 'attributes') {
            const successMessage = modalForm.querySelector('#success-message');
            if (
              successMessage &&
              !successMessage.classList.contains('hidden')
            ) {
              // User subscribed successfully
              localStorage.setItem(STORAGE_KEY, 'true');
              localStorage.removeItem(DISMISSED_KEY);

              // Close modal after showing success for 3 seconds
              setTimeout(() => {
                closeModal();
              }, 3000);
            }
          }
        });
      });

      observer.observe(modalForm, {
        childList: true,
        subtree: true,
        attributes: true,
        attributeFilter: ['class'],
      });
    }

    document.addEventListener('astro:before-preparation', () => {
      clearTimeout(showModalTimer);
      if (!backdrop.classList.contains('hidden')) {
        document.body.style.overflow = '';
      }
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNewsletterModal);
  } else {
    initNewsletterModal();
  }

  document.addEventListener('astro:page-load', initNewsletterModal);
</script>
