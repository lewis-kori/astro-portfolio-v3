---
import ArrowIcon from '../ui/icons/ArrowIcon.astro';

interface Props {
  id?: string;
  showTitle?: boolean;
  title?: string;
  description?: string;
  layout?: 'horizontal' | 'vertical';
}

const {
  id = 'newsletter-form',
  showTitle = true,
  title = 'Join My Newsletter',
  description = 'Get insights on software engineering, startups, and tech trends delivered to your inbox.',
  layout = 'horizontal',
} = Astro.props;

const layoutClasses =
  layout === 'vertical' ? 'flex-col' : 'flex-col sm:flex-row';
---

<div class='space-y-6'>
  {
    showTitle && (
      <div class='space-y-4'>
        <div class='flex items-center gap-3'>
          <div class='h-px w-12 bg-linear-to-r from-primary to-transparent' />
          <span class='text-xs uppercase tracking-wider text-muted-foreground font-medium'>
            Stay Updated
          </span>
        </div>
        <div class='space-y-2'>
          <h3 class='text-2xl font-semibold text-foreground first-letter-color'>
            {title}
          </h3>
          <p class='text-muted-foreground'>{description}</p>
        </div>
      </div>
    )
  }

  <form class='space-y-4 newsletter-form' data-form-id={id}>
    <div id='success-message' class='hidden p-3 rounded-md bg-green-50 border border-green-200 text-green-800 dark:bg-green-950 dark:border-green-800 dark:text-green-200 text-sm transition-opacity duration-300'></div>
    
    <div class={`flex gap-3 ${layoutClasses}`}>
      <div class='flex-1 space-y-1'>
        <input
          type='email'
          name='email'
          id='newsletter-email'
          placeholder='your@email.com'
          required
          class='w-full px-4 py-3 rounded-md border border-border bg-background focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all placeholder:text-muted-foreground'
        />
        <p id='error-message' class='hidden text-sm text-red-600 dark:text-red-400 transition-opacity duration-300'></p>
      </div>
      <button
        type='submit'
        class='px-6 py-3 rounded-md bg-primary text-primary-foreground hover:bg-primary/90 transition-all font-medium inline-flex items-center justify-center gap-2 group whitespace-nowrap self-start disabled:opacity-50 disabled:cursor-not-allowed'
      >
        <span class='button-text'>Subscribe</span>
        <ArrowIcon
          class='w-4 h-4 group-hover:translate-x-1 transition-transform'
        />
      </button>
    </div>
    <p class='text-xs text-muted-foreground italic'>
      No spam, unsubscribe anytime. Your data is safe with me.
    </p>
  </form>
</div>

<script>
  function initNewsletterForm() {
    const forms = document.querySelectorAll('.newsletter-form');
    
    forms.forEach((form) => {
      const emailInput = form.querySelector('#newsletter-email') as HTMLInputElement;
      const submitButton = form.querySelector('button[type="submit"]') as HTMLButtonElement;
      const buttonText = submitButton.querySelector('.button-text') as HTMLSpanElement;
      const errorMessage = form.querySelector('#error-message') as HTMLElement;
      const successMessage = form.querySelector('#success-message') as HTMLElement;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        // Reset messages
        errorMessage.classList.add('hidden');
        successMessage.classList.add('hidden');
        errorMessage.textContent = '';
        successMessage.textContent = '';
        
        const email = emailInput.value.trim(); 
        
        // Client-side validation
        if (!email) {
          errorMessage.textContent = 'Please provide an email address.';
          errorMessage.classList.remove('hidden');
          return;
        }
        
        // Disable button and show loading state
        submitButton.disabled = true;
        buttonText.textContent = 'Subscribing...';
        
        try {
          const response = await fetch('/api/newsletter', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email }),
          });
          
          const data = await response.json();
          
          if (response.ok) {
            successMessage.textContent = data.message;
            successMessage.classList.remove('hidden');
            emailInput.value = '';
            
            // Auto-hide success message after 5 seconds
            setTimeout(() => {
              successMessage.style.opacity = '0';
              setTimeout(() => {
                successMessage.classList.add('hidden');
                successMessage.style.opacity = '1';
              }, 300);
            }, 5000);
          } else {
            errorMessage.textContent = data.error;
            errorMessage.classList.remove('hidden');
            
            // Auto-hide error message after 5 seconds
            setTimeout(() => {
              errorMessage.style.opacity = '0';
              setTimeout(() => {
                errorMessage.classList.add('hidden');
                errorMessage.style.opacity = '1';
              }, 300);
            }, 5000);
          }
        } catch (error) {
          errorMessage.textContent = 'An error occurred. Please try again later.';
          errorMessage.classList.remove('hidden');
          
          // Auto-hide error message after 5 seconds
          setTimeout(() => {
            errorMessage.style.opacity = '0';
            setTimeout(() => {
              errorMessage.classList.add('hidden');
              errorMessage.style.opacity = '1';
            }, 300);
          }, 5000);
        } finally {
          submitButton.disabled = false;
          buttonText.textContent = 'Subscribe';
        }
      });
    });
  }

 
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initNewsletterForm);
  } else {
    initNewsletterForm();
  }

  document.addEventListener('astro:page-load', initNewsletterForm);
</script>
