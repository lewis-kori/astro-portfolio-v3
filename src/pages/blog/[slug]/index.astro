---
import BlogLayout from '@/layouts/BlogLayout.astro';
import { siteConfig } from '@/config';
import { render } from 'astro:content';
import { getEntry } from 'astro:content';
import { getCollection, type CollectionEntry } from 'astro:content';
// Prerender all blog posts as static html at build time
export const prerender = true;

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog');
  return blogPosts.map((post) => {
    const slug = post.id.replace(/\.md$/, '');
    return {
      params: { slug },
      props: { post },
    };
  });
}
const { slug } = Astro.params;

const post = await getEntry('blog', slug as string);
if (!post) {
  return Astro.redirect('/404');
}
const { Content } = await render(post);

// Calculate word count and reading time
const content = post.body;
const wordCount = content.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200); // Average reading speed: 200 words/min

// Get sponsors if they exist
let sponsors: CollectionEntry<'sponsors'>[] = [];
if (post.data.sponsors && post.data.sponsors.length > 0) {
  const allSponsors = await getCollection('sponsors', ({ data }) =>
    post.data.sponsors?.some(
      (sponsorName) => sponsorName.toLowerCase() === data.name.toLowerCase(),
    ),
  );
  sponsors = allSponsors;
}

// Get related blogs from the same series
let relatedBlogs: CollectionEntry<'blog'>[] = [];
if (post.data.series) {
  relatedBlogs = await getCollection(
    'blog',
    ({ data }) =>
      data.series === post.data.series && data.title !== post.data.title,
  );
  relatedBlogs.sort(
    (a, b) => b.data.dateCreated.getTime() - a.data.dateCreated.getTime(),
  );
}

// Use blog cover image if it exists, otherwise fall back to avatar
const blogImage = post.data.cover_image || siteConfig.avatar;
---

<BlogLayout
  title={post.data.title}
  description={post.data.description}
  author={post.data.author}
  dateCreated={post.data.dateCreated}
  tags={post.data.tags}
  coverImage={post.data.cover_image}
  ogImage={blogImage}
  series={post.data.series}
  readingTime={readingTime}
  sponsors={sponsors}
  relatedBlogs={relatedBlogs}
  canonical={post.data.canonical_url}
>
  <Content />
</BlogLayout>
